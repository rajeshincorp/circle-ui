<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body { margin: 0; background: #ffffff; }
        canvas {
          border: 1px solid #000;
          touch-action: none;
          display: block;
        }
    </style>
</head>
<body>

<canvas id="myCanvas" width="600" height="400"></canvas>

<script>
    const canvas = document.getElementById("myCanvas");
    const ctx = canvas.getContext("2d");

    // ----------------- Circle state -----------------
    let circle = { x: 100, y: 200, r: 40 };
    let circleColor = "red";
    let strokeColor = "blue";
    let strokeWidth = 4;

    // Drag state
    let isDragging = false;

    // Animation state
    let isAnimating = false;
    let vx = 3; // px/frame
    let vy = 3; // px/frame
    let animMode = "none"; // "lr" | "ud" | "none"

    // ----------------- Draw -----------------
    function drawCircle() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.beginPath();
      ctx.arc(circle.x, circle.y, circle.r, 0, Math.PI * 2);
      ctx.fillStyle = circleColor;
      ctx.fill();

      ctx.lineWidth = strokeWidth;
      ctx.strokeStyle = strokeColor;
      ctx.stroke();
    }

    // ----------------- Hit test -----------------
    function isPointInCircle(x, y) {
      const dx = x - circle.x;
      const dy = y - circle.y;
      return Math.sqrt(dx * dx + dy * dy) <= circle.r;
    }

    function getPos(clientX, clientY) {
      const rect = canvas.getBoundingClientRect();
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    // ----------------- Drag (mouse) -----------------
    canvas.addEventListener("mousedown", (e) => {
      const p = getPos(e.clientX, e.clientY);
      if (isPointInCircle(p.x, p.y)) {
        isDragging = true;
        stopAnimation(); // stop when user grabs
      }
    });

    window.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      const p = getPos(e.clientX, e.clientY);
      circle.x = p.x;
      circle.y = p.y;
      drawCircle();
    });

    window.addEventListener("mouseup", () => {
      isDragging = false;
    });

    // ----------------- Drag (touch) -----------------
    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      const t = e.touches[0];
      if (!t) return;
      const p = getPos(t.clientX, t.clientY);
      if (isPointInCircle(p.x, p.y)) {
        isDragging = true;
        stopAnimation();
      }
    }, { passive: false });

    canvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      if (!isDragging) return;
      const t = e.touches[0];
      if (!t) return;
      const p = getPos(t.clientX, t.clientY);
      circle.x = p.x;
      circle.y = p.y;
      drawCircle();
    }, { passive: false });

    canvas.addEventListener("touchend", (e) => {
      e.preventDefault();
      isDragging = false;
    }, { passive: false });

    // ----------------- Animation loop -----------------
    function tick() {
      if (!isAnimating) return;

      if (animMode === "lr") {
        circle.x += vx;
        // bounce left/right
        if (circle.x + circle.r >= canvas.width || circle.x - circle.r <= 0) {
          vx *= -1;
        }
      } else if (animMode === "ud") {
        circle.y += vy;
        // bounce up/down
        if (circle.y + circle.r >= canvas.height || circle.y - circle.r <= 0) {
          vy *= -1;
        }
      }

      drawCircle();
      requestAnimationFrame(tick);
    }

    // ----------------- Exposed functions for Android -----------------
    window.renderCircle = function(radius, color) {
      if (radius !== null && radius !== undefined) {
        circle.r = Math.max(5, radius * 10);
      }
      if (color) circleColor = color;
      drawCircle();
    };

    window.startLeftRight = function(speed) {
      if (speed !== null && speed !== undefined) vx = speed;
      animMode = "lr";
      if (!isAnimating) {
        isAnimating = true;
        requestAnimationFrame(tick);
      }
    };

    window.startUpDown = function(speed) {
      if (speed !== null && speed !== undefined) vy = speed;
      animMode = "ud";
      if (!isAnimating) {
        isAnimating = true;
        requestAnimationFrame(tick);
      }
    };

    window.stopAnimation = function() {
      isAnimating = false;
      animMode = "none";
    };

    // internal helper
    function stopAnimation() {
      window.stopAnimation();
    }

    // Initial draw
    drawCircle();
</script>

</body>
</html>
